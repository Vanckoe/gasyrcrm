{% extends 'subjects/base.html' %}

{% load static %}
{% load l10n %}

{% block content %}
    {% include "subjects/components/crm2-mentor-sidebar.html" %}
    <main class="main flex-1 pb-[100px] w-3/4">
        {% include "subjects/components/crm2-header.html" %}
        <div class="pt-[50px] ml-[40px] mr-[78px] max-w-[1040px] grid ">
            <div class="flex items-center justify-between mb-[24px]">
                <h1 class="font-bold text-black-main text-[42px]">
                    Расписание уроков
                </h1>
                <div
                        class="switch__date p-4 flex gap-5 h-15 items-center bg-white shadow-[0px_4px_20px_0px_#0000000A] rounded-md"
                >
                    <button class="previous__date">
                        <img src="{% static 'core/images/crm2/prev-accent-red.png' %}" alt=""
                             class="max-w-[30px] max-h-[30px] rounded-full"/>
                    </button>
                    <div class="switch__date-text">10-17 марта</div>
                    <button class="previous__date">
                        <img src="{% static 'core/images/crm2/next-accent-red.png' %}" alt=""
                             class="max-w-[30px] max-h-[30px] rounded-full"/>
                    </button>
                </div>
            </div>
            <div class="pt-[50px] pl-[40px] pr-[78px] pb-[32px] max-w-[1040px] grid bg-white rounded-lg">
                <div class="flex gap-[4px] mb-[30px] text-center font-bold text-white">
                    <button class="bg-accent-red py-[7px] font-semibold text-[20px] leading-[24px] text-white px-[34px] rounded-[40px]">
                        Понедельник
                    </button>
                    <button class="border-[1px] border-accent-red text-accent-red py-[7px] font-semibold text-[20px] leading-[24px] px-[34px] rounded-[40px]">
                        Вторник
                    </button>
                    <button class="border-[1px] border-accent-red text-accent-red py-[7px] font-semibold text-[20px] leading-[24px] px-[34px] rounded-[40px]">
                        Среда
                    </button>
                    <button class="border-[1px] border-accent-red text-accent-red py-[7px] font-semibold text-[20px] leading-[24px] px-[34px] rounded-[40px]">
                        Четверг
                    </button>
                    <button class="border-[1px] border-accent-red text-accent-red py-[7px] font-semibold text-[20px] leading-[24px] px-[34px] rounded-[40px]">
                        Пятница
                    </button>
                    <button class="border-[1px] border-accent-red text-accent-red py-[7px] font-semibold text-[20px] leading-[24px] px-[34px] rounded-[40px]">
                        Суббота
                    </button>
                </div>
                <div class="grid gap-[40px]">
                    {% for shift in shifts %}
                        <div class="item min-w-full">
                            <p class="text-black-main font-semibold text-[20px] leading-[24px] mb-[8px]">{{ shift.name }}</p>
                            <div class="rounded-lg border-[1px] border-[#CACACA] overflow-x-auto">
                                {% for time in shift.times.all %}
                                    <div class="item p-[16px] flex item-start min-w-max flex-grow {% if not forloop.last %}border-b border-[#CACACA]{% endif %}">
                                        <p class="font-semibold text-[16px] leading-[20px] text-accent-red mr-[24px] w-[100px]">{{ time.start_time|time:"H:i" }}
                                            - {{ time.end_time|time:"H:i" }}</p>
                                        <div class="flex items-center gap-[17px]">
                                            {% for lesson in time.lessons.all %}
                                                <div class="border-t-[10px] border-t-[{{ lesson.subject.color_code }}] min-w-[245px] grid gap-[12px] rounded-lg p-[14px] bg-[#FAFAFA]">
                                                    <div class="flex items-center gap-[8px]">
                                                        <p class="font-semibold text-[16px] leading-20px text-black-main">{{ lesson.teacher.full_name }}</p>
                                                    </div>
                                                    <h3 class="font-semibold text-[20px] leading-[24px] text-black-main">{{ lesson.subject.name }}</h3>
                                                    <h5 class="font-regular text-[14px] leading-[16px] text-black-main">{{ lesson.group_template.name }}</h5>
                                                </div>
                                                {% empty %}
                                                <p>No lessons scheduled for this time.</p>
                                            {% endfor %}
                                            <button class="add-lesson-btn w-[53px] h-[53px] rounded-full border-[1px] border-accent-red text-[34px] text-accent-red"
                                                    data-time-id="{{ time.id }}">
                                                +
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% empty %}
                        <p>No shifts available.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>
    <div id="lessonModal" class="fixed z-10 left-0 top-0 w-full h-full overflow-auto bg-black bg-opacity-40 hidden">
        <div class="bg-white p-5 m-auto mt-32 rounded shadow-lg w-1/2">
            <span class="close float-right text-3xl font-bold cursor-pointer">&times;</span>
            <h1 class="text-xl font-bold mb-4">Create a New Lesson</h1>
            <div id="lessonFormContainer">
                <!-- The form will be loaded here via AJAX -->
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var modal = document.getElementById("lessonModal");
            var closeBtn = document.querySelector(".close");

            closeBtn.onclick = function () {
                modal.style.display = "none";
            };

            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };

            document.querySelectorAll('.add-lesson-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const timeId = this.getAttribute("data-time-id");
                    const urlTemplate = `{% url 'subjects:lesson-create' '999' %}`;  // '999' is a placeholder
                    const url = urlTemplate.replace('999', timeId);
                    fetch(url)
                        .then(response => response.text())
                        .then(html => {
                            document.getElementById('lessonFormContainer').innerHTML = html;
                            modal.style.display = "block";
                        });
                });
            });
        });
    </script>
{% endblock %}