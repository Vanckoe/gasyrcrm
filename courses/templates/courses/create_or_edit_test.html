<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create/Edit Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<form method="post" action="" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="title">Test Title:</label>
    <input type="text" id="title" name="title" required value="{% if test_exists %}{{ test.title }}{% endif %}"><br><br>
    <div id="questionsContainer">
        {% if test_exists %}
            {% for question in test.questions.all %}
                <div class="question">
                    <!-- Hidden input for question ID -->
                    <input type="hidden" name="questions[{{ forloop.counter0 }}][id]" value="{{ question.id }}">

                    <label>Question:</label>
                    <input type="text" name="questions[{{ forloop.counter0 }}][text]" value="{{ question.text }}">
                    <label>Question Type:</label>
                    <select name="questions[{{ forloop.counter0 }}][type]" class="questionTypeSelector">
                        <option value="SC" {% if question.question_type == 'SC' %}selected{% endif %}>Single Choice</option>
                        <option value="MC" {% if question.question_type == 'MC' %}selected{% endif %}>Multiple Choice</option>
                        <option value="IMG" {% if question.question_type == 'IMG' %}selected{% endif %}>Image Based</option>
                        <option value="AUD" {% if question.question_type == 'AUD' %}selected{% endif %}>Audio Based</option>
                    </select>
                    <label>Image File:</label>
                    <input type="file" name="questions[{{ forloop.counter0 }}][image]" accept="image/*" {% if question.question_type == 'IMG' %}required{% endif %}>
                    <label>Audio File:</label>
                    <input type="file" name="questions[{{ forloop.counter0 }}][audio]" accept="audio/*" {% if question.question_type == 'AUD' %}required{% endif %}>
                    <div class="answers">
                        {% for answer in question.answers.all %}
                            <div class="answer">
                                <!-- Hidden input for answer ID -->
                                <input type="hidden" name="questions[{{ forloop.parentloop.counter0 }}][answers][{{ forloop.counter0 }}][id]" value="{{ answer.id }}">

                                <label>Answer:</label>
                                <input type="text" name="questions[{{ forloop.parentloop.counter0 }}][answers][{{ forloop.counter0 }}][text]" required value="{{ answer.text }}">
                                <label>Correct:</label>
                                <input type="checkbox" name="questions[{{ forloop.parentloop.counter0 }}][answers][{{ forloop.counter0 }}][is_correct]" {% if answer.is_correct %}checked{% endif %}>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    <button type="button" id="addQuestion">Add Question</button>
    <input type="hidden" name="question_count" id="questionCount" value="{{ test.questions.count|default:'0' }}">
    <br><br>
    <input type="submit" value="{% if test %}Edit Test{% else %}Create Test{% endif %}">
</form>

<script>
$(document).ready(function() {
    let questionCount = parseInt($('#questionCount').val());

    $('#addQuestion').click(function(e) {
        e.preventDefault();
        let questionHTML = `
            <div class="question" data-index="${questionCount}">
                <label>Question:</label>
                <input type="text" name="questions[${questionCount}][text]" required>
                <label>Question Type:</label>
                <select name="questions[${questionCount}][type]" class="questionTypeSelector">
                    <option value="SC">Single Choice</option>
                    <option value="MC">Multiple Choice</option>
                    <option value="IMG">Image Based</option>
                    <option value="AUD">Audio Based</option>
                </select>
                <label>Image File:</label>
                <input type="file" name="questions[${questionCount}][image]" accept="image/*">
                <label>Audio File:</label>
                <input type="file" name="questions[${questionCount}][audio]" accept="audio/*">
                <div class="answers">` +
                Array.from({ length: 4 }, (_, i) => `
                    <div class="answer">
                        <label>Answer ${i + 1}:</label>
                        <input type="text" name="questions[${questionCount}][answers][${i}][text]" required>
                        <label>Correct:</label>
                        <input type="checkbox" name="questions[${questionCount}][answers][${i}][is_correct]">
                    </div>
                `).join('') + `
                </div>
            </div>`;

        $('#questionsContainer').append(questionHTML);
        $('html, body').animate({ scrollTop: $(`div[data-index="${questionCount}"]`).offset().top }, 'slow');
        questionCount++;
        $('#questionCount').val(questionCount);
    });
});
</script>

</body>
</html>
